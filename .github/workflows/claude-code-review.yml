name: Claude Code Review

on:
  workflow_dispatch:
    inputs:
      runner:
        description: "Runner"
        required: false
        default: "ubuntu-latest"
        type: string
  workflow_call:
    inputs:
      runner:
        description: "Runner"
        required: false
        default: "ubuntu-latest"
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        description: "Anthropic API Key"
        required: true

permissions:
  contents: read

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    name: "Claude Review"
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    if: |
      (github.event.pull_request.author_association == 'OWNER' ||
      github.event.pull_request.author_association == 'MEMBER' ||
      github.event.pull_request.author_association == 'COLLABORATOR') &&
      !contains(github.event.pull_request.title, '[skip-review]') &&
      !contains(github.event.pull_request.title, '[WIP]') &&
      github.event.pull_request.user.login != 'dependabot[bot]'
    steps:
      - name: "Setup: Harden Runner"
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          disable-sudo: true
          egress-policy: audit
      - name: "Setup: Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: "Setup: GraalVM (Java 24)"
        uses: graalvm/setup-graalvm@01ed653ac833fe80569f1ef9f25585ba2811baab # v1.3.3
        with:
          distribution: "graalvm"
          java-version: "24"
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: "Setup: Node"
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 23
      - name: "Setup: Bun"
        uses: step-security/setup-bun@a961ff54612b97ac3259f517fb6a81be3b657a59 # v2.0.2
        with:
          bun-version: "1.2.14"
      - name: "Setup: PNPM"
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: "10.6.2"
      - name: "Setup: Elide"
        uses: elide-dev/setup-elide@990b915b2974a70e7654acb1303607b4cd1d3538 # v2
        with:
          version: "1.0.0-beta5"
      - name: "Review: Claude"
        id: claude-review
        uses: anthropics/claude-code-action@41dd0aa695a06b94f18ce26fd851bfd6ed9d8760 # beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: "claude-opus-4-20250514"
          custom_instructions: |
            Consider the following facts about Elide:
            - Elide is a Node.js-like runtime (i.e. a binary on a user's machine)
            - Elide is powered by Oracle GraalVM and Native Image
            - Elide supports multiple interoperable langs: TypeScript, JS, Python, Kotlin, Java, and others
            - Elide is "batteries-included" with a package installer, builder, and test runner
            - Elide targets JVM and is written in Kotlin, Java, and Rust
            - Elide's native code (Rust and C libraries) is dispatched over JNI, usually
            - Kotlin and Java turn into JVM bytecode, which turns into native code via GraalVM Native Image

            Tools used by the project:
            - Cargo, Rust, Make
            - Gradle, Kotlin (K2), JVM
            - Oracle GraalVM at latest
          direct_prompt: |
            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Be constructive and helpful in your feedback.
            If the developer is a first-time contributor, or encounters issues on their PR, offer to link them
            to Elide's documentation or Discord. Consume from these sources as needed for context. Links:
            - Elide Docs: https://docs.elide.dev/
            - Elide Discord: https://elide.dev/discord
          allowed_tools: |
            Bash(pnpm install)
            Bash(cargo check)
            Bash(cargo build --target=x86_64-unknown-linux-gnu)
            Bash(./gradlew build)
            Bash(./gradlew test)
            Bash(./gradlew check)
            Bash(./gradlew build test check)
            Bash(./gradlew -Pelide.abiValidate=true apiCheck)
