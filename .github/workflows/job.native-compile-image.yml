# Copyright (c) 2025 Elide Technologies, Inc.
#
# Licensed under the MIT license (the "License"); you may not use this file except in compliance
# with the License. You may obtain a copy of the License at
#
# https://opensource.org/license/mit/
#
# Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
# an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under the License.
#

name: Native Image (nativeCompile)

on:
  push:
    branches:
      - feat/deb-native-compile
  workflow_dispatch:

# –∏—Å—Ö–æ–¥–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Ä–µ—é–∑–∞–±–µ–ª—å–Ω–æ–≥–æ –≤–æ—Ä–∫—Ñ–ª–æ—É ‚Äî –ø—Ä–∏–≥–æ–¥—è—Ç—Å—è –ø–æ–∑–∂–µ
# on:
#   workflow_dispatch:
#     inputs:
#       runner:
#         description: "Runner"
#         type: string
#         default: ubuntu-cipool
#
#   workflow_call:
#     inputs:
#       runner:
#         description: "Runner"
#         type: string
#         default: ubuntu-cipool

permissions:
  contents: read

env:
  RUST_BACKTRACE: full
  SCCACHE_DIRECT: "true"
  RUSTC_WRAPPER: "sccache"

jobs:
  gradle:
    name: "Native (linux-amd64, nativeCompile)"
    runs-on: ubuntu-latest
    timeout-minutes: 90

    permissions:
      contents: write
      id-token: write

    env:
      CI: true
      GRADLE_OPTS: "-Dorg.gradle.workers.max=2 -Dorg.gradle.daemon=false"
      ORG_GRADLE_PROJECT_orgGradleParallel: "false"

    defaults:
      run:
        shell: bash

    steps:
      - name: "Setup: Harden Runner"
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          disable-sudo: false
          egress-policy: audit

      - name: "Setup: Checkout"
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0
          submodules: true
          persist-credentials: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup: Packages"
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libtool libtool-bin

      - name: "Setup: Rust"
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
        with:
          toolchain: stable
          cache: true
          cache-key: "elide-rust-v1-{{ hashFiles('Cargo.lock') }}"

      - name: "Setup: SCCache"
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: "Setup: Rust Caching"
        run: echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: "Setup: GraalVM (Java 25)"
        uses: graalvm/setup-graalvm@eec48106e0bf45f2976c2ff0c3e22395cced8243 # v1.4.2
        with:
          distribution: "graalvm"
          java-version: "25"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup: Gradle"
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        id: gradlebuild
        with:
          cache-read-only: false
          dependency-graph: disabled
          gradle-home-cache-cleanup: true
          gradle-home-cache-includes: |
            binaryen
            caches
            jdks
            native
            native-build-tools
            nodejs
            notifications
            wrapper
            yarn

      - name: "Setup: Gradle Settings"
        run: cp -fv ./.github/workflows/gradle-ci.properties ~/.gradle/gradle.properties || echo "No local gradle-ci.properties."

      - name: "Build Environment"
        run: file Makefile && make info CI=yes 2>&1 | tee build-info.txt

      - name: "üõ†Ô∏è Build: Native CLI (nativeCompile)"
        run: |
          ./gradlew \
            :packages:cli:nativeCompile \
            -x check \
            -x test \
            -x jvmTest \
            --no-daemon \
            --no-parallel \
            --build-cache \
            --dependency-verification=off \
            --no-configuration-cache \
            --stacktrace \
            -Pelide.ci=true \
            -PbuildSamples=false \
            -PbuildDocs=false

      - name: "Artifact: Native Build Outputs"
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: elide-native-nativeCompile-linux-amd64
          path: packages/cli/build/native/nativeCompile/**/*

