/// Describes Kotlin configurations for an Elide project.
@ModuleInfo { minPklVersion = "0.28.1" }
module elide.kotlin

import "Jvm.pkl" as jvm

/// Kotlin language targets.
typealias KotlinLanguageTargets = "latest" | "stable" | "auto" | "1.9" | "2.0" | "2.1" | "2.2"

/// Kotlin language levels.
typealias KotlinLanguageLevel = KotlinLanguageTargets

/// Kotlin API levels.
typealias KotlinApiLevel = KotlinLanguageTargets

/// Modes for the JVM target validation mode option when compiling for JVM.
typealias JvmTargetValidationMode = "WARNING" | "ERROR" | "IGNORE"

/// Specifies options which relate to the Kotlin compiler.
abstract class KotlinCompilerOptions {
  /// Opt-ins to add to Kotlin compiler invocations.
  optIn: Listing<String> = new {}

  /// Whether to enable the compiler's progressive mode.
  progressiveMode: Boolean = false

  /// Whether to enable extra K2 warnings and checks.
  extraWarnings: Boolean = false

  /// Report an error if there are any warnings.
  allWarningsAsErrors: Boolean = false

  /// Don't generate any warnings.
  suppressWarnings: Boolean = false

  /// Enable verbose logging output.
  verbose: Boolean = false

  /// Arbitrary arguments to pass to the Kotlin compiler.
  freeCompilerArgs: Listing<String> = new {}

  /// Explicitly set an API version for Kotlin Compiler invocations; this should typically be left at the default, which
  /// allows Elide to align API version options.
  apiVersion: KotlinApiLevel = "auto"

  /// Explicitly set a language version for Kotlin Compiler invocations; this should typically be left at the default,
  /// which allows Elide to align language version options.
  languageVersion: KotlinLanguageLevel = "auto"

  /// Include Kotlin runtime classes within the output artifact.
  includeRuntime: Boolean = false

  /// Don't automatically include the Kotlin Standard Library on the classpath.
  noStdlib: Boolean = false
}

/// Configures the Kotlin compiler when targeting JVM.
class KotlinCompilerJvmOptions extends KotlinCompilerOptions {
  /// Generate metadata for Java 1.8 reflection on method parameters.
  javaParameters: Boolean = false

  /// Explicitly set a JVM target; typically this should be left at the default, which allows Elide to align JVM target
  /// options with Java, as applicable.
  jvmTarget: jvm.JvmTarget = "auto"

  /// Don't automatically include the Java runtime on the classpath.
  noJdk: Boolean = false

  /// Validation of JVM target compatibility between Kotlin and Java.
  jvmTargetValidationMode: JvmTargetValidationMode = "ERROR"
}

/// Specifies Kotlin-related features and options within Elide.
class KotlinFeatureOptions {
  /// Enable or disable annotation processing with kapt.
  kapt: Boolean = true

  /// Enable or disable annotation processing with KSP.
  ksp: Boolean = false

  /// Whether to enable classpath/modulepath injection features.
  injection: Boolean = true

  /// Whether to enable Kotlin's test support features.
  testing: Boolean = true

  /// Whether to enable incremental compilation for Kotlin.
  incremental: Boolean = true

  /// Whether to enable KotlinX dependencies automatically on the classpath.
  kotlinx: Boolean = true

  /// Whether to enable the default suite of built-in plugins for the Kotlin compiler.
  enableDefaultPlugins: Boolean = true

  /// Whether to allow use of experimental features (i.e. compiler plugins).
  experimental: Boolean = false

  /// Enable or disable KotlinX serialization support.
  serialization: Boolean = kotlinx && enableDefaultPlugins && experimental

  /// Enable or disable KotlinX Coroutines support.
  coroutines: Boolean = kotlinx

  /// Enable or disable secret redaction support.
  redaction: Boolean = enableDefaultPlugins && experimental

  /// Whether to automatically calculate classpaths for Kotlin projects.
  autoClasspath: Boolean = true

  /// Whether to enable Kotlin's reflection features.
  reflection: Boolean = true
}

/// Specifies settings which apply to Kotlin projects.
class KotlinSettings {
  /// Set the uniform Kotlin API level. Defaults to auto-detecting the best API level to use.
  apiLevel: KotlinApiLevel = "auto"

  /// Set the uniform Kotlin language target. Defaults to auto-detecting the best language target to use.
  languageLevel: KotlinLanguageLevel = "auto"

  /// Adjust settings for the Kotlin compiler.
  compilerOptions: KotlinCompilerJvmOptions = new {}

  /// Manage Elide settings which relate to Kotlin.
  features: KotlinFeatureOptions = new {}
}
