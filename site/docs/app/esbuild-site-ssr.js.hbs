const fs = require('fs');
const esbuild = require('esbuild');
const { default: mdx } = require("@mdx-js/esbuild");
const { default: rehypeHighlight } = await import("rehype-highlight");
const nodePath = process.env.NODE_PATH;

if (!nodePath) { throw new Error("Failed to resolve NODE_PATH"); }
const settings = {
    entryPoints: ['{{ENTRY}}'],
    outfile: '{{OUTFILE}}',
    format: '{{FORMAT}}',
    minify: {{MINIFY}},
    platform: '{{PLATFORM}}',
    globalName: '{{LIBNAME}}',
    bundle: {{BUNDLE}},
    nodePaths: [{{NODEPATH}}],
    mainFields: ['module', 'main'],
    resolveExtensions: ['.ts','.js','.mjs'],
    sourcemap: !{{PREPACK}},
    inject: [ '{{PROCESS}}' ],
    plugins: [
      mdx({
          rehypePlugins: [rehypeHighlight]
      })
    ],
    external: [
        'buffer',
        'fs',
        'util'
    ]
};

console.info("Bundling SSR library '{{LIBNAME}}'...");
esbuild.build(settings).then(() => {
    console.info("Bundle step completed: embedded SSR bundle ready (mode: {{MODE}}).");
}, () => process.exit(1));
